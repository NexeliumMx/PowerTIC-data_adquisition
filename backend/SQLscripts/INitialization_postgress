SET CONSTRAINTS ALL DEFERRED;

CREATE SCHEMA IF NOT EXISTS PowerTIC;
SET search_path TO PowerTIC;

CREATE TABLE IF NOT EXISTS Locations (
  LocationID SMALLINT PRIMARY KEY,
  NumbMeters INT,
  "Name" TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS Meters (
  serial_number TEXT PRIMARY KEY,
  sunspec_id TEXT NOT NULL,
  id TEXT NOT NULL,
  manufacturer TEXT NOT NULL,
  model TEXT NOT NULL,
  "version" TEXT NOT NULL,
  Locations_LocationID SMALLINT NOT NULL,
  RegisterYear TEXT NOT NULL,
  FOREIGN KEY (Locations_LocationID)
    REFERENCES Locations (LocationID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  UNIQUE (serial_number, Locations_LocationID)
);

CREATE TABLE IF NOT EXISTS ModbusQueries (
  Serial INT PRIMARY KEY,
  modbus_Address JSONB NOT NULL,
  parameter_description TEXT NOT NULL,
  "standard" TEXT NOT NULL,
  data_type TEXT NOT NULL,
  data_range TEXT NOT NULL,
  model TEXT NOT NULL,
  mod_default TEXT NOT NULL,
  register_number SMALLINT NOT NULL,
  indb bool NOT NULL,
  setup bool NOT NULL,
  UNIQUE (Serial),
  UNIQUE (Modbus_Address)
);

CREATE TABLE IF NOT EXISTS Measurements (
  "timestamp" TIMESTAMPTZ NOT NULL,
  amps_total SMALLINT NOT NULL,
  amps_phase_a SMALLINT NOT NULL,
  amps_phase_b SMALLINT NOT NULL,
  amps_phase_c SMALLINT NOT NULL,
  voltage_ln_average SMALLINT NOT NULL,
  phase_voltage_an SMALLINT NOT NULL,
  phase_voltage_bn SMALLINT NOT NULL,
  phase_voltage_cn SMALLINT NOT NULL,
  voltage_ll_average SMALLINT NOT NULL,
  phase_voltage_ab SMALLINT NOT NULL,
  phase_voltage_bc SMALLINT NOT NULL,
  phase_voltage_ca SMALLINT NOT NULL,
  frequency SMALLINT NOT NULL,
  total_real_power SMALLINT NOT NULL,
  watts_phase_a SMALLINT NOT NULL,
  watts_phase_b SMALLINT NOT NULL,
  watts_phase_c SMALLINT NOT NULL,
  ac_apparent_power_va SMALLINT NOT NULL,
  va_phase_a SMALLINT NOT NULL,
  va_phase_b SMALLINT NOT NULL,
  va_phase_c SMALLINT NOT NULL,
  reactive_power_var SMALLINT NOT NULL,
  var_phase_a SMALLINT NOT NULL,
  var_phase_b SMALLINT NOT NULL,
  var_phase_c SMALLINT NOT NULL,
  power_factor SMALLINT NOT NULL,
  pf_phase_a SMALLINT NOT NULL,
  pf_phase_b SMALLINT NOT NULL,
  pf_phase_c SMALLINT NOT NULL,
  total_real_energy_exported INT NOT NULL,
  total_watt_hours_exported_in_phase_a INT NOT NULL,
  total_watt_hours_exported_in_phase_b INT NOT NULL,
  total_watt_hours_exported_in_phase_c INT NOT NULL,
  total_real_energy_imported INT NOT NULL,
  total_watt_hours_imported_phase_a INT NOT NULL,
  total_watt_hours_imported_phase_b INT NOT NULL,
  total_watt_hours_imported_phase_c INT NOT NULL,
  total_va_hours_exported INT NOT NULL,
  total_va_hours_exported_phase_a INT NOT NULL,
  total_va_hours_exported_phase_b INT NOT NULL,
  total_va_hours_exported_phase_c INT NOT NULL,
  total_va_hours_imported INT NOT NULL,
  total_va_hours_imported_phase_a INT NOT NULL,
  total_va_hours_imported_phase_b INT NOT NULL,
  total_va_hours_imported_phase_c INT NOT NULL,
  total_var_hours_imported_q1 INT NOT NULL,
  total_var_hours_imported_q1_phase_a INT NOT NULL,
  total_var_hours_imported_q1_phase_b INT NOT NULL,
  total_var_hours_imported_q1_phase_c INT NOT NULL,
  total_var_hours_imported_q2 INT NOT NULL,
  total_var_hours_imported_q2_phase_a INT NOT NULL,
  total_var_hours_imported_q2_phase_b INT NOT NULL,
  total_var_hours_imported_q2_phase_c INT NOT NULL,
  total_var_hours_exported_q3 INT NOT NULL,
  total_var_hours_exported_q3_phase_a INT NOT NULL,
  total_var_hours_exported_q3_phase_b INT NOT NULL,
  total_var_hours_exported_q3_phase_c INT NOT NULL,
  total_var_hours_exported_q4 INT NOT NULL,
  total_var_hours_exported_q4_phase_a INT NOT NULL,
  total_var_hours_exported_q4_phase_b INT NOT NULL,
  total_var_hours_exported_q4_phase_c INT NOT NULL,
  serial_number TEXT NOT NULL,
  PRIMARY KEY  ("timestamp",serial_number),
  FOREIGN KEY (serial_number)
    REFERENCES Meters (serial_number)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
);

SET CONSTRAINTS ALL IMMEDIATE;

insert into powertic.locations (locationid,numbmeters,"Name") values (0,0,'not_set')